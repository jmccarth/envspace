<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7" />
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    
    <title>
    </title>
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dijit/themes/tundra/tundra.css">
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/esri/css/esri.css" />
	<link rel="stylesheet" type='text/css' href='http://serverapi.arcgisonline.com/jsapi/arcgis/2.3/js/esri/dijit/css/Popup.css'/>
	<link rel="stylesheet" type='text/css' href='http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dojox/layout/resources/ExpandoPane.css'/>
    <link rel="stylesheet" type="text/css" href="css/layout.css"/>
	
    <script type="text/javascript">
      var djConfig = {
        parseOnLoad: true
      };
    </script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2">
    </script>
    <script type="text/javascript">
      dojo.require("dijit.dijit"); // optimize: load dijit layer
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
	  dojo.require("dijit.TitlePane");
	  dojo.require("dijit.form.CheckBox");
	  dojo.require("dijit.form.Select");
	  
	  dojo.require("dojox.grid.DataGrid");
      dojo.require("dojo.data.ItemFileReadStore");
	  dojo.require("dojox.layout.ExpandoPane");
	  
      dojo.require("esri.map");
	  dojo.require("esri.layers.FeatureLayer");
	  dojo.require("esri.dijit.Popup");
	  dojo.require("esri.dijit.Legend");
	  dojo.require("esri.dijit.AttributeInspector-all");
	  dojo.require("esri.tasks.GenerateRendererTask");
      
	  require(["dijit/form/DropDownButton","dijit/Menu","dijit/Calendar","dijit/Dialog"]);
	  
      var map, roomsLayer, roomsUpdateLayer, basemap;
	  var legend = null;
	  var customLods = [];
	  var loadCount = 0;
	  var roomsLayerURL = "https://services1.arcgis.com/DwLTn0u9VBSZvUPe/arcgis/rest/services/envspace/FeatureServer/0";
	  var roomsUpdateLayerURL = "https://services1.arcgis.com/DwLTn0u9VBSZvUPe/arcgis/rest/services/envspace_edit/FeatureServer/0";

      function init() {
		//Basemap layers
		
		//basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
		
		basemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",
			{displayLevels:[15,16,17,18,19]});
		
		if(basemap.loaded){
			addLods(basemap);
		}
		else{
			dojo.connect(basemap,"onLoad",addLods);
		}
		
		/*
		ourbasemap = new esri.layers.ArcGISTiledMapServiceLayer("http://maps.uwaterloo.ca/ArcGIS/rest/services/mobile/uw_base/MapServer",
			{displayLevels:[20,21]});
		
		if(ourbasemap.loaded){
			addLods(ourbasemap);
		}
		else{
			dojo.connect(ourbasemap,"onLoad",addLods);
		}
		*/
		
		//Rooms feature layer
		
		//create popup infotemplate
		var template = new esri.InfoTemplate();
		template.setTitle("Attributes of ${LONGNAME}");
		template.setContent(
			"Department ID: ${Department_ID}<br />" +
			"Department Name: ${Department_Name}<br />" +
			"Area (Assignable Sq. Ft.): ${Assignable_Square_Feet}<br />" +
			"Usage (IAP): ${Function_ID_and_Name}<br />" +
			"<button onclick='startEdit(\"${SPACEID}\")'>Edit</button>"
		);
		
        roomsLayer = new esri.layers.FeatureLayer(roomsLayerURL,{
			infoTemplate:template,
			outFields:["*"],
			mode:esri.layers.FeatureLayer.MODE_ONDEMAND
		});
		
		//define a selection symbol 
        var highlightSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,
								new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,
								new dojo.Color([255,0,0]), 2),new dojo.Color([255,255,0,0.25]));
        roomsLayer.setSelectionSymbol(highlightSymbol);
		
		dojo.connect(roomsLayer,"onClick",function(evt){
			map.infoWindow.setFeatures([evt.graphic]);
			map.infoWindow.show(evt.mapPoint);
		});
		
		roomsUpdateLayer = new esri.layers.FeatureLayer(roomsUpdateLayerURL,{
			outFields:["*"],
			mode:esri.layers.FeatureLayer.MODE_ONDEMAND,
			visible:false
		});

      }
	  
	  function startEdit(spaceid){
		map.infoWindow.hide();
		
		var sQuery = new esri.tasks.Query();
		sQuery.where = "SPACEID='" + spaceid + "'";
		roomsUpdateLayer.selectFeatures(sQuery,esri.layers.FeatureLayer.SELECTION_NEW,function(results){
			dijit.byId('editDialog').show();
		},
		function(err){
			console.log(err);
		});
	  }
	  
	  function initMap(){
		var initialExtent = new esri.geometry.Extent({
          "xmin": -8966082.128405,
          "ymin": 5383419.130605,
          "xmax": -8965889.190495,
          "ymax": 5383576.988895,
          "spatialReference": {
            "wkid": 102113
          }
        });
		var popup= new esri.dijit.Popup(null,dojo.create("div"));
        map = new esri.Map("map", {
          extent: initialExtent,
		  infoWindow:popup,
		  lods: customLods
        });
		/*map = new esri.Map("map", {
          extent: initialExtent,
		  infoWindow:popup
        });*/
        dojo.connect(map, 'onLoad', function(map) {
          //resize the map when the browser resizes
          dojo.connect(dijit.byId('map'), 'resize', map,map.resize);
        });
		
		/*dojo.connect(map, 'onLayerAddResult', function(addedLayer){
			alert(addedLayer);
		})*/
		
		map.addLayer(basemap);
		//map.addLayer(ourbasemap);
		map.addLayer(roomsUpdateLayer);
		map.addLayer(roomsLayer);
		
		
		legend = new esri.dijit.Legend({
			map:map,
			layerInfos:[{layer:roomsLayer,title:'Rooms'}]
		},"legendDiv");
		legend.startup();
		
		if (roomsUpdateLayer.loaded){
			createAttInspector();
		}
		else{
			dojo.connect(roomsUpdateLayer,"onLoad",function(){
				createAttInspector();
			});
		}
		
		changeFloor(1);

		buildReportDialog();
		symbolizeDefault();
	  }
	
	function createAttInspector(){
		var layerInfo = [{
			'featureLayer':roomsUpdateLayer,
			'showDeleteButton':false,
			'fieldInfos':[
				{'fieldName': 'LONGNAME','label':'Room Name','isEditable':false},
				{'fieldName': 'Function_ID_and_Name','label':'Function','isEditable':true},
				{'fieldName': 'Department_Name','label':'Department','isEditable':true}
			]	
		}];
		
		var attInspector = new esri.dijit.AttributeInspector(
			{layerInfos:layerInfo},
			"attrInsp"
		);
		
		dojo.connect(attInspector,"onAttributeChange",function(feature,fieldName,newFieldValue){
			feature.attributes[fieldName] = newFieldValue;
			feature.getLayer().applyEdits(null,[feature],null);
		});
	}
	
	
	//Fill array with levels of detail
	function addLods(lyr) {
		customLods = customLods.concat(lyr.tileInfo.lods);
		loadCount++;

		if (loadCount === 1) {
		  initMap();
		}
	}
	/**
		symbolizeByDepartment()
		
		Send a request off to the rooms layer to generate a unique values renderer based on the department name.
		Build a colour ramp and apply it to the rooms layer, then refresh.
	*/	
	function symbolizeByDepartment(){
		var generateRenderer = new esri.tasks.GenerateRendererTask(roomsLayerURL);
		var params = new esri.tasks.GenerateRendererParameters();
		
		var classDef = new esri.tasks.UniqueValueDefinition();
		classDef.attributeField = "Department_Name";
		classDef.baseSymbol = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([255,0,0,0.5]));
		var cRamp = new esri.tasks.AlgorithmicColorRamp();
		cRamp.fromColor = dojo.colorFromHex("#0033ff");
		cRamp.toColor = dojo.colorFromHex("#ff3300");
		cRamp.algorithm = "hsv";
		classDef.colorRamp = cRamp;
		
		params.classificationDefinition = classDef;
		params.where = "1=1";
		
		generateRenderer.execute(params, function(renderer){
			roomsLayer.setRenderer(renderer);
			roomsLayer.refresh();
			legend.refresh();
		}, function(err){
			console.log(err);
		});
	  }
	
	/**
		symbolizeByFunction()
		
		Send a request off to the rooms layer to generate a unique values renderer based on the function name.
		Build a colour ramp and apply it to the rooms layer, then refresh.
	*/	
	
	function symbolizeByFunction(){
		var generateRenderer = new esri.tasks.GenerateRendererTask(roomsLayerURL);
		var params = new esri.tasks.GenerateRendererParameters();
		
		var classDef = new esri.tasks.UniqueValueDefinition();
		classDef.attributeField = "Function_ID_and_Name";
		classDef.baseSymbol = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([255,0,0,0.5]));
		var cRamp = new esri.tasks.AlgorithmicColorRamp();
		cRamp.fromColor = dojo.colorFromHex("#998ec3");
		cRamp.toColor = dojo.colorFromHex("#f1a340");
		cRamp.algorithm = "hsv";
		classDef.colorRamp = cRamp;
		
		params.classificationDefinition = classDef;
		params.where = "1=1";
		
		generateRenderer.execute(params, function(renderer){
			roomsLayer.setRenderer(renderer);
			roomsLayer.refresh();
			legend.refresh();
		}, function(err){
			console.log(err);
		});
		
	}
	  
	/**
		symbolizeDefault()
			
		Create a basic single-symbol renderer to show the rooms.
	*/
	function symbolizeDefault(){
		var symbol = new esri.symbol.SimpleFillSymbol().setColor(new dojo.Color([0,100,100]));
		symbol.outline.setStyle(esri.symbol.SimpleLineSymbol.STYLE_NULL);
		var renderer = new esri.renderer.SimpleRenderer(symbol);
		roomsLayer.setRenderer(renderer);
		roomsLayer.refresh();
		legend.refresh();
	 }
	  
	/**
		changeFloor()
		
		When called, change the visible floor by using a definition expression to filter out all rooms not on that floor
		
		BUG:Need to find a way to signal the caller that this function is done
	*/
	function changeFloor(floorNum){
		roomsLayer.setDefinitionExpression("FLOORKEY LIKE '%F" + floorNum + "'");
		dijit.byId("floorButton").set("label","Floor " + floorNum);
		map.infoWindow.hide();
	}

	  
	/**
		buildReportDialog()
		
		Gets list of unique departments and functions and populates the lists in the report dialog
	*/
	function buildReportDialog(){
		// Get list of departments
		allRoomsQuery = new esri.tasks.Query();
		
		allRoomsQuery.outFields = ["Department_Name","Function_ID_and_Name"];
		allRoomsQuery.where = "OBJECTID >= 0";
		
		
		var byDeptTask = new esri.tasks.QueryTask(roomsLayerURL);
		byDeptTask.execute(allRoomsQuery,function(results){
			var uniqueDepts = [];
			var uniqueFuncs = [];
			for (room in results.features){
				if (uniqueDepts.indexOf(results.features[room].attributes["Department_Name"]) == -1){
					uniqueDepts.push(results.features[room].attributes["Department_Name"]);
				}
				
				if (uniqueFuncs.indexOf(results.features[room].attributes["Function_ID_and_Name"]) == -1){
					uniqueFuncs.push(results.features[room].attributes["Function_ID_and_Name"]);
				}
			}
			
			var dList = dijit.byId("deptList");
			for (dept in uniqueDepts){
				deptName = uniqueDepts[dept];
				dList.addOption({
					label:deptName,
					value:deptName
				});
			}
			
			var fList = dijit.byId("funcList");
			for (func in uniqueFuncs){
				funcName = uniqueFuncs[func];
				fList.addOption({
					label:funcName,
					value:funcName
				});
			}
		});
	}
	  
	/** 
		generateReport()
	*/
	  function generateReport(){
		var deptName;
		var funcName;
		var showASF = dijit.byId("asfCheck").get("checked");
		
		var byDept = new esri.tasks.Query();
		var byDeptTask = new esri.tasks.QueryTask(roomsLayerURL);
		
		byDept.where = "";
		
		if (dijit.byId("byDeptCheck").get("checked")){
			deptName = dijit.byId("deptList").get("value");
			byDept.where += "Department_Name = '" + deptName + "'";
		}
		if (dijit.byId("byFuncCheck").get("checked")){
			funcName = dijit.byId("funcList").get("value");
			if (byDept.where.length > 0){
				byDept.where += " AND Function_ID_and_Name = '" + funcName + "'";
			}
			else{
				byDept.where += "Function_ID_and_Name = '" + funcName + "'";
			}
		}
		
		byDept.outFields = ["*"];
		byDeptTask.execute(byDept,function(featureSet){
			var totalSpace = 0;
			for (room in featureSet.features){
				totalSpace += featureSet.features[room].attributes.Assignable_Square_Feet
			}
			
			var items = dojo.map(featureSet.features,function(feature){
              return feature.attributes;
            });
            var data = {
              identifier:"OBJECTID",
              items:items};
            store = new dojo.data.ItemFileReadStore({data:data});
            grid.setStore(store);
            grid.setSortIndex(1,"true");
			
			if (showASF){
				alert("Total Assignable Square Feet is:" + totalSpace);
			}

			
		});
		reportDialog.hide();
		
	  }

	  
	function reportByFunctionResults(funcName){
		var byFunc = new esri.tasks.Query();
		var byFuncTask = new esri.tasks.QueryTask(roomsLayerURL);
		
		byFunc.where = "Function_ID_and_Name = '" + funcName + "'";
		byFunc.outFields = ["*"];
		byFuncTask.execute(byFunc,function(featureSet){
			var totalSpace = 0;
			for (room in featureSet.features){
				totalSpace += featureSet.features[room].attributes.Assignable_Square_Feet
			}
			
			var items = dojo.map(featureSet.features,function(feature){
              return feature.attributes;
            });
            var data = {
              identifier:"OBJECTID",
              items:items};
            store = new dojo.data.ItemFileReadStore({data:data});
            grid.setStore(store);
            grid.setSortIndex(1,"true");
			
			alert("Total Assignable Square Feet for " + funcName + " is:" + totalSpace);
		});
	}
	  /* END TABULAR REPORT BY OWNER */
	  
	  function zoomTo(id){
        var zBtn = "<a onClick=\"zoomRow('"+id+"')\">Show</a>";
        return zBtn;
	  }
	  
	  function zoomRow(id){
        roomsLayer.clearSelection();
        
		var query = new esri.tasks.Query();
        query.objectIds = [id];
		query.outFields = ["*"];
		
		var floorQueryTask = new esri.tasks.QueryTask(roomsLayerURL);
		
		floorQueryTask.execute(query,function(results){
			floorkey = results.features[0].attributes["FLOORKEY"];
			changeFloor(floorkey.substr(floorkey.length - 1,1));			
			roomsLayer.selectFeatures(query,esri.layers.FeatureLayer.SELECTION_NEW,function(features){
			  //zoom to the selected feature
			  var roomExtent = features[0].geometry.getExtent().expand(5.0);
			  map.setExtent(roomExtent);
			});
		});
      }
	
	function clear(){
		roomsLayer.clearSelection();
		map.infoWindow.hide();
	}
	
      //show map on load 
      dojo.addOnLoad(init);
    </script>
  </head>
  
	<body class="tundra">
		<div id="mainWindow" dojotype="dijit.layout.BorderContainer" design="sidebar" liveSplitters="true" style="width:100%; height:100%;">
			<!-- CENTER -->
			<div id="map" class="centerPanel" dojotype="dijit.layout.ContentPane" region="center">
				<div id="floatTools" style="position:absolute; left:700px; top:10px; z-Index:999;">
					<div id="floorButton" data-dojo-type="dijit.form.DropDownButton" label="Floor 1">
						<div data-dojo-type="dijit.Menu">
							<div data-dojo-type="dijit.MenuItem" onClick="changeFloor(1)">1</div>
							<div data-dojo-type="dijit.MenuItem" onClick="changeFloor(2)">2</div>
							<div data-dojo-type="dijit.MenuItem" onClick="changeFloor(3)">3</div>
							<div data-dojo-type="dijit.MenuItem" onClick="changeFloor(4)">4</div>
						</div>
					</div>
					<div data-dojo-type="dijit.form.DropDownButton">
						<span>Choose Date</span>
						<div data-dojo-type="dijit.Menu">
							<div data-dojo-type="dijit.Calendar"></div>
						</div>
					</div>
					<div data-dojo-type="dijit.form.Button" label="Report" onclick="reportDialog.show()">
					</div>
					<div data-dojo-type="dijit.form.DropDownButton">
						<span>Vizualize</span>
						<div data-dojo-type="dijit.Menu">
							<div data-dojo-type="dijit.MenuItem" onClick="symbolizeByDepartment()">By Department</div>
							<div data-dojo-type="dijit.MenuItem" onClick="symbolizeByFunction()">By Function</div>
							<div data-dojo-type="dijit.MenuItem" onClick="symbolizeDefault()">Default</div>
						</div>
					</div>
					<div data-dojo-type="dijit.form.Button" label="Clear" onclick="clear()">
					</div>
				</div>
				<div dojotype="dijit.TitlePane" style="position:absolute; left:20px; bottom:10px; z-Index:999; height:300px; width: 200px; overflow:auto" title="Legend">
					<div style="overflow:auto">
						<div id="legendDiv"></div>
					</div>
				</div>
			</div>
			
			<!-- BOTTOM -->
			<div id="footer" title="Results" class="edgePanel" dojotype="dojox.layout.ExpandoPane" region="bottom" style="height:20%;" splitter="true">
				<table data-dojo-type="dojox.grid.DataGrid" id="grid" jsid="grid">
					<thead>
						<tr>
							<th field="OBJECTID" formatter="zoomTo" width="5%">Zoom To</th>
							<th field="LONGNAME" width="10%">Room</th>
							<th field="Department_Name" width="35%">Department</th>
							<th field="Function_ID_and_Name" width="35%">Function</th>
							<th field="Assignable_Square_Feet" width="15%">Assignable Square Feet</th>
						</tr>
					</thead>
				</table>
			</div>
		</div>
		
		<div id="editDialog" data-dojo-type="dijit.Dialog" data-dojo-id="editDialog" title="Edit Feature" style="width:500px;height:300px">
			<div id="attrInsp"></div>
		</div>
		
		<div id="reportDialog" data-dojo-type="dijit.Dialog" data-dojo-id="reportDialog" title="Generate a Report" style="width:600px">
			<input id="byDeptCheck" data-dojo-type="dijit.form.CheckBox" checked onclick='dijit.byId("deptList").set("disabled",!dijit.byId("deptList").get("disabled"))'/><label for="byDeptCheck">By Department</label>
			<div id="deptList" data-dojo-type="dijit.form.Select"></div>
			<br />
			<input id="byFuncCheck" data-dojo-type="dijit.form.CheckBox" checked onclick='dijit.byId("funcList").set("disabled",!dijit.byId("funcList").get("disabled"))'/><label for="byFuncCheck">By Function</label>
			<div id="funcList" data-dojo-type="dijit.form.Select"></div>
			<br />
			<input id="asfCheck" data-dojo-type="dijit.form.CheckBox" checked /><label for="asfCheck">Show ASF Total?</label>
			<br />
			<button data-dojo-type="dijit.form.Button" type="button" onclick="generateReport()">
				Generate Report
			</button>
		</div>
		<div id="legendDialog" data-dojo-type="dijit.Dialog" data-dojo-id="legendDialog"></div>
	</body>
</html>
